<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Real Time Bus Tracker</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  .map-overlay{
    position: absolute;
    left: 0;
    padding: 10px;
  }
</style>
<script type='text/javascript' src='config.js'></script>
</head>
<body>

	<div id="map"></div>
	<div class="map-overlay top">
		<button onclick="run()" type="button" id="bus-tracker-button" style="font-size: 2em;">Track Bus</button>
	</div>

	<script>

		mapboxgl.accessToken = config.MAPBOX_KEY;
		
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/streets-v11',
			center: [-71.104081, 42.365554],
			zoom: 14
		});

		const listOfBuses = [];
		const listOfMarkers = [];

		async function run(){
			// get bus data    
			const locations = await getBusLocations();
			// assign a marker for each bus's latitude and longitude data
			let busOff = [];

			
			for (let i = 0; i < locations.length; i++){
				console.log(locations[i]);
				let busID = locations[i].id;
				let inListOfBuses = listOfBuses.includes(busID);
				// will return the marker with the busID
				let inListOfMarkers = listOfMarkers.find((element) => element[0] === busID);

				// if bus exists, change the markers
				if (listOfBuses.includes(busID)){
					if (inListOfMarkers !== undefined){
					// change the marker's location
						let marker = inListOfMarkers[1];
						marker.setLngLat([locations[i].attributes.longitude, locations[i].attributes.latitude]);
					}
				} 
				
				// if bus does not exist yet, create a new marker
				else {
					let marker = new mapboxgl.Marker()
					.setLngLat([locations[i].attributes.longitude, locations[i].attributes.latitude])
					.addTo(map);

					listOfMarkers.push([locations[i].id, marker]);
					listOfBuses.push(locations[i].id);
				};
			}

			// timer
			setTimeout(run, 5000);
		}

		

		

		// Request bus data from MBTA
		async function getBusLocations(){
			const url = 'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
			const response = await fetch(url);
			const json     = await response.json();
			return json.data;
		}



	</script>
</body>
</html>